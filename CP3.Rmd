---
title: "CP3"
author: "Ledia Dobi"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

## library chunk
# First, install any packages that are not already installed
```{r libraries, include=TRUE}
required_packages <- c("dplyr", "readr", "tidyverse", "lmtest", "lubridate", "glmnet", "pls", "readxl", "GGally", "boot", "scales", "ggthemes", "caret")
install.packages(setdiff(required_packages, rownames(installed.packages())))
```

# Second, load all the packages
```{r load, include=TRUE}
invisible(lapply(required_packages, library, character.only = TRUE))
```

# Import Datasets
```{r import beauty, include=TRUE}
beauty <- read.csv("Beauty Care.csv")
```
```{r import hair, include=TRUE}
hair <- read.csv("Hair.csv")
```
```{r import household, include=TRUE}
household <- read.csv("Household Care.csv")
```
```{r import makeup, include=TRUE}
makeup <- read.csv("Makeup.csv")
```
```{r import pet, include=TRUE}
pet <- read.csv("Pet Care.csv")
```
```{r import skincare, include=TRUE}
skincare <- read.csv("Skincare.csv")
```


# Cleaning Datasets
```{r clean, include=TRUE}

#Converting characters into numeric 
beauty_cleaned <- beauty %>%
  mutate(
    `Units.sold` = as.numeric(`Units.sold`),
    `Dollar.Sales.UD` = as.numeric(`Dollar.Sales.UD`),
    `Avg.Price.USD` = as.numeric(`Avg.Price.USD`),
  )

hair_cleaned <- hair %>%
  mutate(
    `Units.sold` = as.numeric(`Units.sold`),
    `Dollar.Sales.UD` = as.numeric(`Dollar.Sales.UD`),
    `Avg.Price.USD` = as.numeric(`Avg.Price.USD`),
    `YOY...Change` = as.numeric(`YOY...Change`)
  )

household_cleaned <- household %>%
  mutate(
    `Units.sold` = as.numeric(`Units.sold`),
    `Dollar.Sales.UD` = as.numeric(`Dollar.Sales.UD`),
    `Avg.Price.USD` = as.numeric(`Avg.Price.USD`),
    `YOY...Change` = as.numeric(`YOY...Change`)
  )

makeup_cleaned <- makeup %>%
  mutate(
    `Units.sold` = as.numeric(`Units.sold`),
    `Dollar.Sales.UD` = as.numeric(`Dollar.Sales.UD`),
    `Avg.Price.USD` = as.numeric(`Avg.Price.USD`),
    `YOY...Change` = as.numeric(`YOY...Change`)
  )

pet_cleaned <- pet %>%
  mutate(
    `Units.sold` = as.numeric(`Units.sold`),
    `Dollar.Sales.UD` = as.numeric(`Dollar.Sales.UD`),
    `Avg.Price.USD` = as.numeric(`Avg.Price.USD`),
    `YOY...Change` = as.numeric(`YOY...Change`)
  )

skincare_cleaned <- skincare %>%
  mutate(
    `Units.sold` = as.numeric(`Units.sold`),
    `Dollar.Sales.UD` = as.numeric(`Dollar.Sales.UD`),
    `Avg.Price.USD` = as.numeric(`Avg.Price.USD`),
    `YOY...Change` = as.numeric(`YOY...Change`)
  )
```

# Aggregate by year
```{r aggregation, include=TRUE}
# Hair
# Group by both 'Year' and 'Category'
hair_aggregated <- hair_cleaned %>%
  group_by(Year, Category) %>%
  summarize(
    total_units_sold = sum(`Units.sold`, na.rm = TRUE),
    total_dollar_sales = sum(`Dollar.Sales.UD`, na.rm = TRUE),
    mean_avg_price = mean(`Avg.Price.USD`, na.rm = TRUE),
    mean_yoy_change = mean(`YOY...Change`, na.rm = TRUE)
  ) %>%
  # Calculate the more accurate weighted average price
  mutate(
    weighted_avg_price = total_dollar_sales / total_units_sold
  )


# Beauty
# Group by 'Year'
beauty_aggregated <- beauty_cleaned %>%
  group_by(Year) %>%
  summarize(
    total_units_sold = sum(`Units.sold`, na.rm = TRUE),
    total_dollar_sales = sum(`Dollar.Sales.UD`, na.rm = TRUE),
    mean_avg_price = mean(`Avg.Price.USD`, na.rm = TRUE),
  ) %>%
  # Add the 'Category' column with the value "Beauty"
  mutate(
    Category = "Beauty"
  ) %>%
  # Calculate the more accurate weighted average price
  mutate(
    weighted_avg_price = total_dollar_sales / total_units_sold
  )


# Household
# Group by 'Year'
household_aggregated <- household_cleaned %>%
  group_by(Year) %>%
  summarize(
    total_units_sold = sum(`Units.sold`, na.rm = TRUE),
    total_dollar_sales = sum(`Dollar.Sales.UD`, na.rm = TRUE),
    mean_avg_price = mean(`Avg.Price.USD`, na.rm = TRUE),
    mean_yoy_change = mean(`YOY...Change`, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    Category = "Household",
    weighted_avg_price = total_dollar_sales / total_units_sold
  )

# Makeup
# Group by 'Year'
makeup_aggregated <- makeup_cleaned %>%
  group_by(Year) %>%
  summarize(
    total_units_sold = sum(`Units.sold`, na.rm = TRUE),
    total_dollar_sales = sum(`Dollar.Sales.UD`, na.rm = TRUE),
    mean_avg_price = mean(`Avg.Price.USD`, na.rm = TRUE),
    mean_yoy_change = mean(`YOY...Change`, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    Category = "Makeup",
    weighted_avg_price = total_dollar_sales / total_units_sold
  )

# Pet
# Group by 'Year'
pet_aggregated <- pet_cleaned %>%
  group_by(Year) %>%
  summarize(
    total_units_sold = sum(`Units.sold`, na.rm = TRUE),
    total_dollar_sales = sum(`Dollar.Sales.UD`, na.rm = TRUE),
    mean_avg_price = mean(`Avg.Price.USD`, na.rm = TRUE),
    mean_yoy_change = mean(`YOY...Change`, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    Category = "Pet",
    weighted_avg_price = total_dollar_sales / total_units_sold
  )

# Skincare
# Group by 'Year'
skincare_aggregated <- skincare_cleaned %>%
  group_by(Year) %>%
  summarize(
    total_units_sold = sum(`Units.sold`, na.rm = TRUE),
    total_dollar_sales = sum(`Dollar.Sales.UD`, na.rm = TRUE),
    mean_avg_price = mean(`Avg.Price.USD`, na.rm = TRUE),
    mean_yoy_change = mean(`YOY...Change`, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    Category = "Skincare",
    weighted_avg_price = total_dollar_sales / total_units_sold
  )
```


# Reorder to make "Category" the second column
```{r reorder, include=TRUE}
#Hair
hair_aggregated <- hair_aggregated %>%
  select(Year, Category, everything())

#Beauty
beauty_aggregated <- beauty_aggregated %>%
  select(Year, Category, everything())

#Household
household_aggregated <- household_aggregated %>%
  select(Year, Category, everything())

#Makeup
makeup_aggregated <- makeup_aggregated %>%
  select(Year, Category, everything())

#Pet
pet_aggregated <- pet_aggregated %>%
  select(Year, Category, everything())

#Skincare
skincare_aggregated <- skincare_aggregated %>%
  select(Year, Category, everything())

```

# Remove Column Mean YOY Change
```{r remove mean_yoy_change, include=TRUE}

#Hair
hair_aggregated <- hair_aggregated %>%
  select(-mean_yoy_change)

#Household
household_aggregated <- household_aggregated %>%
  select(-mean_yoy_change)

#Makeup
makeup_aggregated <- makeup_aggregated %>%
  select(-mean_yoy_change)

#Pet
pet_aggregated <- pet_aggregated %>%
  select(-mean_yoy_change)

#Skincare
skincare_aggregated <- skincare_aggregated %>%
  select(-mean_yoy_change)
```


# Merge datasets
```{r merge, include=TRUE}

# Convert the 'Year' column to a character type in all dataframes
beauty_aggregated <- beauty_aggregated %>%
  mutate(Year = as.character(Year))

hair_aggregated <- hair_aggregated %>%
  mutate(Year = as.character(Year))

pet_aggregated <- pet_aggregated %>%
  mutate(Year = as.character(Year))

skincare_aggregated <- skincare_aggregated %>%
  mutate(Year = as.character(Year))

household_aggregated <- household_aggregated %>%
  mutate(Year = as.character(Year))

makeup_aggregated <- makeup_aggregated %>%
  mutate(Year = as.character(Year))

# Merge all the dataframes into a single, comprehensive dataframe
cpg <- bind_rows(
  beauty_aggregated,
  hair_aggregated,
  pet_aggregated,
  skincare_aggregated,
  household_aggregated,
  makeup_aggregated
)

# arrange the dataframe by Year and Category to make it easier to view
cpg <- cpg %>%
  arrange(Year, Category)

view(cpg)
```

# Import Autosales data, mutate it to fit other datasets conventions
```{r import auto datasets, include=TRUE}
auto <- read.csv("AutoSales.csv")
view(auto)

auto <- auto %>%
  # Step 1: Extract the year from the 'observation_date' column
  # and convert it to a character type for consistent merging later on
  mutate(observation_date = as.character(year(as.Date(observation_date)))) %>%
  
  # Step 2: Add a new column 'Category' as the second column
  # and fill it with the value "Auto"
  add_column(Category = "Auto", .after = "observation_date") %>%
  
  # Step 3: Rename the column 'LAUTOSA' to 'total_units_sold'
  # and multiple its values by 1,000,000 to convert to millions
  mutate(total_units_sold = LAUTOSA * 1000000) %>%
  select(-LAUTOSA) # Remove the old 'LAUTOSA' column
view(auto)

auto <- auto %>%
  # Step 1: Rename the 'observation_date' column to 'Year'
  rename(Year = observation_date) %>%
  
  # Step 2: Group by 'Year' and aggregate the data
  group_by(Year, Category) %>%
  summarize(
    total_units_sold = sum(total_units_sold, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  
  # Step 3: Filter for years between 2000 and 2024
  # Ensure 'Year' is treated as a numeric variable for proper filtering
  filter(as.numeric(Year) >= 2000 & as.numeric(Year) <= 2024)
view(auto)
```

# Merge auto with cpg dataframe
```{r import datasets, include=TRUE}
# Convert the 'Year' column in the 'auto' dataframe to a character
# to match the data type of the 'Year' column in the 'cpg' dataframe.
auto <- auto %>%
  mutate(Year = as.character(Year))

# Now, use bind_rows() to combine the 'auto' and 'cpg' dataframes.
# This stacks the rows from 'auto' on top of the rows from 'cpg'.
all_data <- bind_rows(cpg, auto)

# Arrange the final dataframe by year and category for better readability
all_data <- all_data %>%
  arrange(Year, Category)

view(all_data)
```

# Saving a copy of all_data locally
```{r downloading all_data, include=TRUE}
write.csv(all_data, "all_data.csv", row.names = FALSE)
```


# Preliminary Analysis
```{r preliminary analysis, include=TRUE}

# --- 1. Load the data ---
# Load the combined data file from the current directory
all_data <- read.csv("all_data.csv", header = TRUE, stringsAsFactors = FALSE)

# --- 2. Data Preparation and Filtering ---
# Filter for the 'Makeup' category
makeup_data <- all_data %>%
  # Ensure 'total_units_sold' is numeric for calculations
  mutate(total_units_sold = as.numeric(total_units_sold)) %>%
  # Filter for the 'Makeup' category
  filter(Category == "Makeup")

# --- 3. Statistical Analysis ---

# Calculate core statistics
stats_report <- makeup_data %>%
  summarise(
    # Count & Missingness
    N_Observations = n(),
    N_Missing_Values = sum(is.na(total_units_sold)),
    
    # Central Tendency
    Mean = mean(total_units_sold, na.rm = TRUE),
    Median = median(total_units_sold, na.rm = TRUE),
    
    # Measures of Spread
    Standard_Deviation = sd(total_units_sold, na.rm = TRUE),
    Range = max(total_units_sold, na.rm = TRUE) - min(total_units_sold, na.rm = TRUE),
    Q1 = quantile(total_units_sold, 0.25, na.rm = TRUE),
    Q3 = quantile(total_units_sold, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1
  )

# --- 4. Outlier Detection (Using the 1.5 * IQR Rule) ---

# Calculate the outlier fences
IQR_val <- stats_report$IQR
Q1_val <- stats_report$Q1
Q3_val <- stats_report$Q3

lower_fence <- Q1_val - 1.5 * IQR_val
upper_fence <- Q3_val + 1.5 * IQR_val

# Identify outliers
outliers <- makeup_data %>%
  filter(total_units_sold < lower_fence | total_units_sold > upper_fence) %>%
  select(Year, total_units_sold)

# --- 5. Frequency/Distribution ---
# Create a frequency table (shows count of units sold within common ranges/bins)
frequency_table <- makeup_data %>%
  mutate(Sales_Bin = cut(total_units_sold, breaks = 5)) %>%
  group_by(Sales_Bin) %>%
  summarise(Frequency = n(), .groups = 'drop') %>%
  mutate(Percent = (Frequency / sum(Frequency)) * 100)

# --- 6. Print Report ---

cat("\n--- UNIVARIATE ANALYSIS REPORT: Makeup Total Units Sold ---\n\n")

cat("A. Count and Missingness:\n")
cat(paste("  - Number of Observations (Years):", stats_report$N_Observations, "\n"))
cat(paste("  - Number of Missing Values (NA):", stats_report$N_Missing_Values, "\n\n"))

cat("B. Central Tendency (Center):\n")
cat(paste("  - Mean:", round(stats_report$Mean, 2), "\n"))
cat(paste("  - Median:", round(stats_report$Median, 2), "\n\n"))

cat("C. Measures of Spread (Dispersion):\n")
cat(paste("  - Standard Deviation:", round(stats_report$Standard_Deviation, 2), "\n"))
cat(paste("  - Range (Max - Min):", round(stats_report$Range, 2), "\n"))
cat(paste("  - Interquartile Range (IQR):", round(stats_report$IQR, 2), "\n\n"))

cat("D. Outliers (1.5 * IQR Rule):\n")
if (nrow(outliers) > 0) {
  cat(paste("  - Found", nrow(outliers), "Outlier(s):\n"))
  print(outliers)
} else {
  cat("  - No Outliers Detected.\n")
}

cat("\nE. Frequency Distribution (Binned Units Sold):\n")
print(frequency_table)

# --- 7. Visualization for Shape Analysis ---

# Create a histogram to show the frequency distribution
makeup_histogram_plot <- ggplot(makeup_data, aes(x = total_units_sold)) +
  geom_histogram(binwidth = 20000000, fill = "hotpink", color = "white") +
  labs(
    title = "Frequency Distribution of Makeup Total Units Sold",
    x = "Total Units Sold",
    y = "Frequency"
  ) +
  theme_minimal()

print(makeup_histogram_plot)

# Create a box plot to visualize center, spread, and outliers
makeup_boxplot_plot <- ggplot(makeup_data, aes(y = total_units_sold)) +
  geom_boxplot(fill = "#FF69B4", color = "darkgrey", outlier.color = "red") +
  labs(
    title = "Box Plot of Makeup Total Units Sold",
    subtitle = paste("Outliers outside fences:", round(lower_fence, 2), "to", round(upper_fence, 2)),
    y = "Total Units Sold"
  ) +
  theme_minimal()

print(makeup_boxplot_plot)
```